## AI服务模块 (aiService.js)

这个模块是整个答题系统的AI服务核心，负责管理多种AI提供商的配置、API调用、题目生成和答案评估。它采用了统一的接口设计，支持多种免费和付费的大模型API，为系统提供了强大的AI能力支撑。

### 模块架构设计

#### 1. 配置驱动架构

模块采用配置驱动的设计模式，通过`AI_CONFIGS`对象统一管理所有AI提供商的配置信息：

```javascript
const AI_CONFIGS = {
  openai: { name: 'OpenAI', baseURL: '...', model: 'gpt-3.5-turbo' },
  qwen: { name: '通义千问', baseURL: '/api/qwen', model: 'qwen-plus' },
  // ... 其他配置
}
```

**设计优势**：
- **可扩展性**：添加新的AI服务只需在配置对象中增加条目
- **统一管理**：所有API配置集中维护，便于更新和调试
- **类型安全**：配置结构统一，减少运行时错误

#### 2. 单例模式实现

模块导出单例实例，确保全局状态的一致性：

```javascript
const aiService = new AIService()
export default aiService
```

**设计原因**：
- **状态一致性**：确保AI配置在整个应用中保持同步
- **资源优化**：避免重复创建实例，节省内存
- **简化使用**：组件可以直接导入使用，无需实例化

### 核心功能模块

#### 1. AI提供商配置管理

##### 支持的AI服务

**OpenAI兼容接口**：
- 支持官方API和第三方代理服务
- 可自定义baseURL，适配不同的服务提供商
- 使用标准的OpenAI API格式

**通义千问 (Qwen)**：
- 阿里云提供的大模型服务
- 预配置API密钥，开箱即用
- 提供免费额度，适合开发测试

**文心一言 (Ernie)**：
- 百度提供的大模型服务
- 使用特殊的认证方式（access_token）
- 支持多种模型版本

**智谱AI (Zhipu)**：
- 支持GLM系列模型
- 使用Bearer Token认证
- 提供高质量的中文理解能力

**模拟AI (Mock)**：
- 用于开发测试和演示
- 无需API密钥，生成模拟数据
- 提供完整的响应格式，便于前端开发

##### 配置结构设计

每个AI服务的配置包含以下标准字段：
- **name**：显示名称，用于UI展示
- **baseURL**：API基础地址
- **model**：默认使用的模型名称
- **headers**：请求头模板，支持动态替换API密钥

#### 2. 动态配置管理

##### updateConfig(newConfig)
更新AI服务配置的核心方法：

**处理逻辑**：
```javascript
this.config = { ...this.config, ...newConfig }
```

**支持的配置项**：
- **provider**：AI提供商标识
- **apiKey**：API密钥
- **customBaseURL**：自定义API地址（主要用于OpenAI兼容服务）

**设计特点**：
- 使用对象展开语法，保持配置的不可变性
- 支持部分更新，只修改传入的字段
- 配置变更立即生效，无需重启

##### getCurrentConfig()
获取当前有效配置的方法：

**处理流程**：
1. 根据当前provider获取基础配置
2. 应用用户的自定义配置（如customBaseURL）
3. 返回完整的可用配置对象

**错误处理**：
- 验证provider的有效性
- 抛出明确的错误信息，便于调试

#### 3. 答案评估系统

##### buildEvaluationPrompt(questions, answers)
构建评估提示词的核心方法：

**提示词结构**：
1. **角色定义**："你是一个专业的教育评估AI助手"
2. **题目信息**：包含问题、标准答案、用户答案、题型
3. **输出格式**：详细的JSON Schema定义
4. **评估要求**：具体的评分标准和反馈要求

**设计亮点**：
- **结构化输出**：使用JSON Schema确保响应格式的一致性
- **详细要求**：明确评分范围、反馈内容、建议格式
- **索引对应**：确保questionIndex与题目顺序的准确对应
- **容错处理**：要求AI返回有效JSON，便于解析

##### evaluateAnswers(questions, answers)
主要的评估入口方法：

**处理流程**：
1. 构建评估提示词
2. 调用AI API获取响应
3. 解析AI响应为结构化数据
4. 验证和补全评估结果
5. 添加时间戳和唯一ID

**错误处理**：
- 捕获API调用异常
- 提供详细的错误信息
- 支持降级处理（使用默认评分）

#### 4. 题目生成系统

##### 文档内容提取

**extractDocumentContent(files)**：
支持多种文档格式的内容提取：

**支持格式**：
- **TXT**：纯文本文件，直接读取
- **DOC/DOCX**：Word文档，使用mammoth库解析
- **PDF**：PDF文档，预留接口（需要pdf.js等库）

**安全限制**：
- 文件大小限制：10MB
- 格式验证：只处理支持的文件类型
- 错误隔离：单个文件解析失败不影响其他文件

**返回格式**：
```javascript
{
  filename: '文件名',
  content: '提取的文本内容',
  size: 文件大小,
  type: '文件类型'
}
```

##### buildQuestionGenerationPrompt(documentContents, questionConfig)
构建题目生成提示词：

**输入参数**：
- **documentContents**：文档内容数组
- **questionConfig**：题目配置（类型、数量、难度分布）

**提示词设计**：
1. **角色定义**："专业的教育题目生成AI助手"
2. **学习资料**：完整的文档内容
3. **生成要求**：详细的题目类型、数量、难度要求
4. **格式规范**：JSON Schema和具体的题目格式要求

**质量保证**：
- 要求题目基于提供的学习资料
- 明确各种题型的格式要求
- 指定难度分布的百分比
- 确保输出格式的标准化

##### generateQuestions(files, questionConfig)
题目生成的主入口方法：

**处理流程**：
1. 提取上传文件的内容
2. 验证内容提取结果
3. 构建题目生成提示词
4. 调用AI API生成题目
5. 解析和验证生成结果

**错误处理**：
- 文档内容为空时抛出明确错误
- API调用失败时提供详细错误信息
- 解析失败时返回空题目数组

#### 5. API调用统一处理

##### callAI(prompt)
AI API调用的核心方法，支持多种AI提供商：

**OpenAI/智谱AI格式**：
```javascript
{
  model: 'model-name',
  messages: [{ role: 'user', content: prompt }],
  temperature: 0.7,
  max_tokens: 2000
}
```

**通义千问格式**：
- 使用相同的消息格式
- 通过代理接口调用

**文心一言格式**：
- 使用access_token认证
- 特殊的参数名称（max_output_tokens）

**请求处理**：
1. 根据provider构建不同的请求体
2. 动态替换API密钥
3. 发送HTTP请求
4. 解析不同格式的响应
5. 统一错误处理

**响应解析**：
- OpenAI格式：`data.choices[0].message.content`
- 文心一言格式：`data.result`
- 错误处理：提供详细的错误信息

#### 6. 模拟AI系统

##### getMockResponse(prompt)
生成模拟AI响应，用于测试和演示：

**智能解析**：
- 从提示词中提取题目数量
- 根据题目数量生成对应的评估结果

**模拟数据生成**：
- **随机评分**：60-100分的合理分布
- **多样化反馈**：从预定义的反馈库中随机选择
- **个性化建议**：每题1-3个随机建议
- **整体评价**：根据分数段提供不同的整体反馈

**数据质量**：
- 确保JSON格式的正确性
- 提供真实感的评估内容
- 支持完整的功能测试

##### generateMockQuestions(questionConfig)
生成模拟题目，支持完整的题目生成流程测试：

**题型支持**：
- **选择题**：4个选项，答案为选项字母
- **判断题**：随机生成正确/错误答案
- **填空题**：使用___表示空白处
- **问答题**：提供详细的示例答案

**难度分配**：
- 根据配置的难度百分比分配题目难度
- 确保难度分布的合理性
- 提供不同难度的示例内容

#### 7. 响应解析与错误处理

##### parseAIResponse(response)
AI响应解析的通用方法：

**解析策略**：
1. **直接解析**：尝试直接JSON.parse
2. **提取解析**：使用正则表达式提取JSON部分
3. **降级处理**：解析失败时返回默认结果

**容错机制**：
- 多层次的解析尝试
- 详细的错误日志记录
- 优雅的降级处理
- 确保系统的稳定性

##### 错误处理策略

**分层错误处理**：
1. **网络层**：HTTP请求失败
2. **API层**：API响应错误
3. **解析层**：JSON解析失败
4. **业务层**：数据验证失败

**用户友好的错误信息**：
- 避免技术术语
- 提供可操作的建议
- 区分不同类型的错误
- 支持错误追踪和调试

### 设计模式与最佳实践

#### 1. 策略模式
通过配置对象和条件分支，实现了不同AI提供商的策略模式：
- 统一的接口定义
- 不同的实现策略
- 运行时动态切换
- 易于扩展新策略

#### 2. 工厂模式
`getCurrentConfig()`方法体现了工厂模式的思想：
- 根据配置生成不同的API客户端配置
- 封装复杂的创建逻辑
- 提供统一的创建接口

#### 3. 适配器模式
不同AI提供商的API格式适配：
- 统一的内部接口
- 适配不同的外部API
- 隐藏API差异
- 简化使用复杂度

#### 4. 模板方法模式
提示词构建方法体现了模板方法模式：
- 定义算法骨架
- 子步骤可以定制
- 保证流程的一致性

### 性能优化策略

#### 1. 动态导入
使用动态导入减少初始包大小：
```javascript
const mammoth = await import('mammoth')
```

#### 2. 文件大小限制
- 10MB文件大小限制
- 避免内存溢出
- 提升处理速度

#### 3. 错误隔离
- 单个文件处理失败不影响其他文件
- 部分成功的处理策略
- 提高系统的健壮性

#### 4. 缓存策略
- 配置信息的内存缓存
- 避免重复的配置解析
- 提升响应速度

### 安全性考虑

#### 1. API密钥保护
- 本地存储，不上传服务器
- 动态替换，避免硬编码
- 支持环境变量配置

#### 2. 输入验证
- 文件类型验证
- 文件大小限制
- 内容格式检查

#### 3. 错误信息脱敏
- 避免泄露敏感信息
- 提供安全的错误提示
- 支持调试模式

### 扩展性设计

#### 1. 新AI服务接入
添加新的AI服务只需要：
1. 在`AI_CONFIGS`中添加配置
2. 在`callAI`方法中添加对应的处理逻辑
3. 测试API调用和响应解析

#### 2. 新功能模块
- 模块化的方法设计
- 清晰的接口定义
- 独立的功能测试

#### 3. 配置扩展
- 支持更多的配置参数
- 动态配置加载
- 配置验证机制

### 使用示例

#### 基本配置
```javascript
import aiService from '@/services/aiService'

// 更新AI配置
aiService.updateConfig({
  provider: 'openai',
  apiKey: 'your-api-key',
  customBaseURL: 'https://api.openai.com/v1'
})
```

#### 答案评估
```javascript
// 评估答案
const evaluation = await aiService.evaluateAnswers(questions, answers)
console.log('评估结果:', evaluation)
```

#### 题目生成
```javascript
// 生成题目
const questions = await aiService.generateQuestions(files, {
  selectedTypes: ['choice', 'essay'],
  questionCounts: { choice: 5, essay: 3 },
  difficulty: { easy: 30, medium: 50, hard: 20 }
})
```

### 技术特色总结

1. **多AI提供商支持**：统一接口，灵活切换
2. **智能提示词工程**：结构化的提示词设计
3. **文档处理能力**：多格式文档内容提取
4. **模拟测试支持**：完整的Mock数据生成
5. **错误处理机制**：多层次的容错处理
6. **性能优化**：动态导入和资源限制
7. **安全性保障**：API密钥保护和输入验证
8. **扩展性设计**：配置驱动的架构模式

这个AI服务模块为整个答题系统提供了强大而灵活的AI能力支撑，通过精心的架构设计和实现，确保了系统的稳定性、可扩展性和用户体验。